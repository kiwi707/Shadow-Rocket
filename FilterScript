let customCharStart = "â—";
let customCharEnd = "áµ€á¶»";

// å…³é”®è¯å’Œå¯¹åº”çš„æŒ‡å®šåç§°
const keywordsToNames = {
    "ç¾|è¥¿é›…å›¾": "ğŸ‡ºğŸ‡¸US",
    "æ¸¯": "ğŸ‡­ğŸ‡°HK",
    "æ–°": "ğŸ‡¸ğŸ‡¬SG",
    "å°": "ğŸ‡¨ğŸ‡³TW",
    "æ—¥|ä¸œäº¬": "ğŸ‡¯ğŸ‡µJP",
    "éŸ©å›½": "ğŸ‡°ğŸ‡·KR",
    "åœŸè€³å…¶": "ğŸ‡¹ğŸ‡·TR",
    "çˆ±å°”å…°": "ğŸ‡®ğŸ‡ªIRL",
    "æ¾³": "ğŸ‡¦ğŸ‡ºAU",
    "æ³•å›½|å·´é»": "ğŸ‡«ğŸ‡·FRA",
    // ç»§ç»­æ·»åŠ å…¶ä»–å…³é”®è¯å’Œå¯¹åº”åç§°
};

// è¦è¿‡æ»¤æ‰çš„å…³é”®è¯
const filterKeywords = [
    "å¹¿å‘Š", "è¿‡æœŸ", "æ— æ•ˆ", "æµ‹è¯•", "å¤‡ç”¨", "å®˜ç½‘", "è´¦å·", "æœ‰æ•ˆæœŸ", "ç¾¤", "åˆ°æœŸ", "åˆ·æ–°", "å‰©ä½™", "è¿‡æœŸ", "ç”µæŠ¥", "ä¼šå‘˜", "è§£é”", "æµé‡", "è¶…æ—¶", "è®¢é˜…", "ä½£é‡‘", "å…ç¿»", "èŠ‚ç‚¹", "ä¸‹è½½", "æµé‡", "æ›´æ–°", "ç‚¹å¤–", "é‡ç½®", "å…æµ", "Days", "Date", "Expire", "Premium", "å»ºè®®", "å…è´¹"  // æ·»åŠ æ‚¨æƒ³è¦è¿‡æ»¤æ‰çš„å…³é”®è¯
];

// ä¸åšå¤„ç†ä½†è¦ä¿ç•™çš„å…³é”®è¯
const skipKeywords = [
    "GPT",  // æ·»åŠ æ‚¨å¸Œæœ›ä¿ç•™ä¸‹æ¥çš„å…³é”®è¯
];

// æ£€æŸ¥æ˜¯å¦åŒ…å«è¿‡æ»¤å…³é”®è¯
for (const filter of filterKeywords) {
    if (new RegExp(filter, 'i').test($server.title)) {
        return false;  // å¦‚æœåŒ¹é…è¿‡æ»¤å…³é”®è¯ï¼Œç›´æ¥è¿”å› false
    }
}

// ä¿ç•™çš„å…³é”®è¯ (å¦‚ GPT)
let preservedParts = [];
let titleWithoutSkipKeywords = $server.title;

// æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸å¤„ç†å…³é”®è¯
for (const skip of skipKeywords) {
    const skipRegex = new RegExp(skip, 'i');
    if (skipRegex.test($server.title)) {
        const match = $server.title.match(skipRegex);
        if (match) {
            preservedParts.push(match[0]);  // ä¿ç•™åŒ¹é…åˆ°çš„å…³é”®è¯
            titleWithoutSkipKeywords = titleWithoutSkipKeywords.replace(skipRegex, '');  // å»é™¤ä¸å¤„ç†å…³é”®è¯åçš„éƒ¨åˆ†
        }
    }
}

let newTitle = titleWithoutSkipKeywords;  // åˆå§‹å€¼ä¸ºå»é™¤ä¿ç•™å…³é”®è¯åçš„æ ‡é¢˜éƒ¨åˆ†
let matchedReplacementKeyword = false;

// éå†å…³é”®è¯ï¼Œå¦‚æœåŒ¹é…åˆ™æ›¿æ¢åç§°
for (const keyword in keywordsToNames) {
    if (new RegExp(keyword, 'i').test(newTitle)) {
        newTitle = keywordsToNames[keyword];  // æ›¿æ¢ä¸ºå¯¹åº”åç§°
        matchedReplacementKeyword = true;  // æ ‡è®°ä¸ºåŒ¹é…äº†æ›¿æ¢å…³é”®è¯
        break;  // æ‰¾åˆ°åç›´æ¥è·³å‡ºå¾ªç¯
    }
}

// æœ€ç»ˆå¤„ç†åç§°
if (matchedReplacementKeyword) {
    // å¦‚æœåªåŒ¹é…åˆ°æ›¿æ¢å…³é”®è¯ï¼Œè¿›è¡Œæ›¿æ¢
    // newTitle å·²ç»åœ¨ä¸Šé¢è¢«èµ‹å€¼ä¸ºæŒ‡å®šåç§°
} else {
    newTitle = $server.title;  // ä¿ç•™åŸåç§°
}

// æ·»åŠ å‰ç¼€å­—ç¬¦
newTitle = customCharStart + newTitle;

// å¤„ç†é‡å¤è®¡æ•°
const map = globalThis.map || (globalThis.map = {});
if (!map[newTitle]) {
    map[newTitle] = 1;
} else {
    const idx = ++map[newTitle];
    newTitle = `${newTitle}-${idx}`;
}

// æ·»åŠ åç¼€å­—ç¬¦
newTitle += customCharEnd;

// å°†ä¿ç•™çš„å…³é”®è¯æ·»åŠ åˆ°æ ‡é¢˜åé¢
if (preservedParts.length > 0) {
    newTitle = newTitle + ' ' + preservedParts.join(' ');  // å°†ä¿ç•™çš„éƒ¨åˆ†æ‹¼æ¥åˆ°æ–°æ ‡é¢˜çš„åé¢
}

// æ›´æ–°æœåŠ¡å™¨æ ‡é¢˜
$server.title = newTitle;

return true;
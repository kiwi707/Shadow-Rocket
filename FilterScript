let customCharStart = "â¥";
let customCharEnd = "áµáµ—";

// å›½å®¶å’Œåœ°åŒºä¸æ ‡è¯†ç¬¦çš„æ˜ å°„ï¼ˆåŒ…æ‹¬ä¸­æ–‡å’Œè‹±æ–‡åï¼‰
const keywordsToNames = {
    "ç¾å›½|ç¾åœ‹|US|æ´›æ‰çŸ¶|æ´›æ‰ç£¯|è¥¿é›…å›¾|çº½çº¦|èŠåŠ å“¥|Atlanta|States|American|Los Angeles|Seattle|New York|Chicago": "ğŸ‡ºğŸ‡¸US",
    "æ¸¯|é¦™æ¸¯|HK|Hong Kong": "ğŸ‡­ğŸ‡°HK",
    "æ–°åŠ å¡|ç‹®åŸ|SG|Singapore": "ğŸ‡¸ğŸ‡¬SG",
    "å°|å°æ¹¾|å°åŒ—|é«˜é›„|TW|Taiwan|Taipei|Kaohsiung": "ğŸ‡¨ğŸ‡³TW",
    "æ—¥|ä¸œäº¬|å¤§é˜ª|åå¤å±‹|JP|Tokyo|Japan|Osaka|Nagoya": "ğŸ‡¯ğŸ‡µJP",
    "éŸ©å›½|é¦–å°”|é‡œå±±|KR|Korea|Seoul|Busan": "ğŸ‡°ğŸ‡·KR",
    "åœŸè€³å…¶|ä¼Šæ–¯å¦å¸ƒå°”|å®‰å¡æ‹‰|TR|Turkey|Istanbul|Ankara": "ğŸ‡¹ğŸ‡·TR",
    "çˆ±å°”å…°|éƒ½æŸæ—|IE|Ireland|Dublin": "ğŸ‡®ğŸ‡ªIRL",
    "æ¾³|æ‚‰å°¼|å¢¨å°”æœ¬|å¸ƒé‡Œæ–¯ç­|AU|Australia|Sydney|Melbourne|Brisbane": "ğŸ‡¦ğŸ‡ºAU",
    "æ³•å›½|å·´é»|é‡Œæ˜‚|é©¬èµ›|FR|France|Paris|Lyon|Marseille": "ğŸ‡«ğŸ‡·FRA",
    "ç‘å…¸|æ–¯å¾·å“¥å°”æ‘©|å“¥å¾·å ¡|SE|Sweden|Stockholm|Gothenburg": "ğŸ‡¸ğŸ‡ªSE",
    "å¾·å›½|æ³•å…°å…‹ç¦|æŸæ—|æ…•å°¼é»‘|DE|Germany|Frankfurt|Berlin|Munich": "ğŸ‡©ğŸ‡ªDE",
    "è‹±å›½|ä¼¦æ•¦|æ›¼å½»æ–¯ç‰¹|ä¼¯æ˜ç¿°|GB|UK|United Kingdom|London|Manchester|Birmingham": "ğŸ‡¬ğŸ‡§GB",
    "å°åº¦|å­Ÿä¹°|å¾·é‡Œ|ç­åŠ ç½—å°”|IN|India|Mumbai|Delhi|Bangalore": "ğŸ‡®ğŸ‡³IN",
    "åŠ æ‹¿å¤§|å¤šä¼¦å¤š|æ¸©å“¥å|è’™ç‰¹åˆ©å°”|CA|Canada|Toronto|Vancouver|Montreal": "ğŸ‡¨ğŸ‡¦CA",
    "è¥¿ç­ç‰™|é©¬å¾·é‡Œ|å·´å¡ç½—é‚£|ES|Spain|Madrid|Barcelona": "ğŸ‡ªğŸ‡¸ES",
    "æ„å¤§åˆ©|ç½—é©¬|ç±³å…°|é‚£ä¸å‹’æ–¯|IT|Italy|Rome|Milan|Naples": "ğŸ‡®ğŸ‡¹IT",
    "è·å…°|é˜¿å§†æ–¯ç‰¹ä¸¹|é¹¿ç‰¹ä¸¹|NL|Netherlands|Amsterdam|Rotterdam": "ğŸ‡³ğŸ‡±NL",
    "ç‘å£«|è‹é»ä¸–|æ—¥å†…ç“¦|CH|Switzerland|Zurich|Geneva": "ğŸ‡¨ğŸ‡­CH",
    "ä¿„ç½—æ–¯|è«æ–¯ç§‘|åœ£å½¼å¾—å ¡|RU|Russia|Moscow|Saint Petersburg": "ğŸ‡·ğŸ‡ºRU",
    "å·´è¥¿|åœ£ä¿ç½—|é‡Œçº¦çƒ­å†…å¢|BR|Brazil|SÃ£o Paulo|Rio de Janeiro": "ğŸ‡§ğŸ‡·BR",
    "å—é|çº¦ç¿°å†…æ–¯å ¡|å¼€æ™®æ•¦|ZA|South Africa|Johannesburg|Cape Town": "ğŸ‡¿ğŸ‡¦ZA",
    "å¢¨è¥¿å“¥|å¢¨è¥¿å“¥åŸ|ç“œè¾¾æ‹‰å“ˆæ‹‰|MX|Mexico|Mexico City|Guadalajara": "ğŸ‡²ğŸ‡½MX",
    "é˜¿æ ¹å»·|å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯|AR|Argentina|Buenos Aires": "ğŸ‡¦ğŸ‡·AR",
    "æ³¢å…°|åæ²™|å…‹æ‹‰ç§‘å¤«|PL|Poland|Warsaw|Krakow": "ğŸ‡µğŸ‡±PL",
    "æ³°å›½|æ›¼è°·|æ¸…è¿ˆ|TH|Thailand|Bangkok|Chiang Mai": "ğŸ‡¹ğŸ‡­TH",
    "é©¬æ¥è¥¿äºš|å‰éš†å¡|æ§ŸåŸ|MY|Malaysia|Kuala Lumpur|Penang": "ğŸ‡²ğŸ‡¾MY",
    "è¶Šå—|æ²³å†…|èƒ¡å¿—æ˜|VN|Vietnam|Hanoi|Ho Chi Minh": "ğŸ‡»ğŸ‡³VN",
    "è²å¾‹å®¾|é©¬å°¼æ‹‰|PH|Philippines|Manila": "ğŸ‡µğŸ‡­PH",
    "åŸƒåŠ|å¼€ç½—|EG|Egypt|Cairo": "ğŸ‡ªğŸ‡¬EG",
    "æ²™ç‰¹|åˆ©é›…å¾—|å‰è¾¾|SA|Saudi Arabia|Riyadh|Jeddah": "ğŸ‡¸ğŸ‡¦SA",
    "é˜¿è”é…‹|è¿ªæ‹œ|é˜¿å¸ƒæ‰æ¯”|AE|UAE|Dubai|Abu Dhabi": "ğŸ‡¦ğŸ‡ªAE",
    "æŒªå¨|å¥¥æ–¯é™†|NO|Norway|Oslo": "ğŸ‡³ğŸ‡´NO",
    "èŠ¬å…°|èµ«å°”è¾›åŸº|FI|Finland|Helsinki": "ğŸ‡«ğŸ‡®FI",
    "å¥¥åœ°åˆ©|ç»´ä¹Ÿçº³|AT|Austria|Vienna": "ğŸ‡¦ğŸ‡¹AT",
    "å¸Œè…Š|é›…å…¸|GR|Greece|Athens": "ğŸ‡¬ğŸ‡·GR",
    "åŒˆç‰™åˆ©|å¸ƒè¾¾ä½©æ–¯|HU|Hungary|Budapest": "ğŸ‡­ğŸ‡ºHU",
    "æ·å…‹|å¸ƒæ‹‰æ ¼|CZ|Czech|Prague": "ğŸ‡¨ğŸ‡¿CZ",
    "æ–°è¥¿å…°|å¥¥å…‹å…°|NZ|New Zealand|Auckland": "ğŸ‡³ğŸ‡¿NZ",
    "å°¼æ³Šå°”|åŠ å¾·æ»¡éƒ½|NP|Nepal|Kathmandu": "ğŸ‡³ğŸ‡µNP",
    "è‘¡è„ç‰™|é‡Œæ–¯æœ¬|PT|Portugal|Lisbon": "ğŸ‡µğŸ‡¹PT",
    "å·´åŸºæ–¯å¦|ä¼Šæ–¯å…°å ¡|PK|Pakistan|Islamabad": "ğŸ‡µğŸ‡°PK",
    "ä¼Šæœ—|å¾·é»‘å…°|IR|Iran|Tehran": "ğŸ‡®ğŸ‡·IR",
    "ä¼Šæ‹‰å…‹|å·´æ ¼è¾¾|IQ|Iraq|Baghdad": "ğŸ‡®ğŸ‡¶IQ",
    "é˜¿å°”åŠåˆ©äºš|é˜¿å°”åŠå°”|DZ|Algeria|Algiers": "ğŸ‡©ğŸ‡¿DZ",
    "æ‘©æ´›å“¥|æ‹‰å·´ç‰¹|MA|Morocco|Rabat": "ğŸ‡²ğŸ‡¦MA",
    "å°¼æ—¥åˆ©äºš|æ‹‰å„æ–¯|NG|Nigeria|Lagos": "ğŸ‡³ğŸ‡¬NG",
    "æ™ºåˆ©|åœ£åœ°äºšå“¥|CL|Chile|Santiago": "ğŸ‡¨ğŸ‡±CL",
    "ç§˜é²|åˆ©é©¬|PE|Peru|Lima": "ğŸ‡µğŸ‡ªPE",
    "å“¥ä¼¦æ¯”äºš|æ³¢å“¥å¤§|CO|Colombia|BogotÃ¡": "ğŸ‡¨ğŸ‡´CO"
};

// è¿‡æ»¤å…³é”®è¯ï¼Œé˜²æ­¢æ— æ•ˆæˆ–å¹¿å‘ŠèŠ‚ç‚¹
const filterKeywords = [
    "å¹¿å‘Š", "è¿‡æœŸ", "æ— æ•ˆ", "æµ‹è¯•", "å¤‡ç”¨", "å®˜ç½‘", "è´¦å·", "æœ‰æ•ˆæœŸ", "ç¾¤", 
    "åˆ°æœŸ", "åˆ·æ–°", "å‰©ä½™", "ç”µæŠ¥", "ä¼šå‘˜", "è§£é”", "æµé‡", "è¶…æ—¶", 
    "è®¢é˜…", "ä½£é‡‘", "å…ç¿»", "èŠ‚ç‚¹", "ä¸‹è½½", "æ›´æ–°", "ç‚¹å¤–", "é‡ç½®", 
    "å…æµ", "Days", "Date", "Expire", "Premium", "å»ºè®®", "å…è´¹",
    "å¥—é¤", "åˆ°æœŸ", "æœ‰æ•ˆ", "å‰©ä½™", "ç‰ˆæœ¬", "å·²ç”¨", "è¿‡æœŸ", "å¤±è”", 
    "æµ‹è¯•", "å®˜æ–¹", "ç½‘å€", "å¤‡ç”¨", "ç¾¤", "TEST", "å®¢æœ", "ç½‘ç«™", 
    "è·å–", "è®¢é˜…", "æµé‡", "æœºåœº", "ä¸‹æ¬¡", "å®˜å€", "è”ç³»", "é‚®ç®±", 
    "å·¥å•", "å­¦æœ¯", "USE", "USED", "TOTAL", "EXPIRE", "EMAIL"
];

// å®šä¹‰ä¿ç•™çš„å…³é”®è¯åŠå…¶æ›¿æ¢è¯
const preserveKeywordsMap = {
    "HY2": "GPT",
    "ä¿ç•™çš„å…³é”®è¯2": "æ›¿æ¢è¯2"
};

// æ£€æŸ¥æ˜¯å¦åŒ…å«è¿‡æ»¤å…³é”®è¯
if (filterKeywords.some(kw => new RegExp(kw, 'i').test($server.title))) return false;

// ä¿ç•™è·³è¿‡çš„å…³é”®è¯éƒ¨åˆ†
let preservedParts = [], newTitle = $server.title;

// æå–å¹¶ç§»é™¤è·³è¿‡çš„å…³é”®è¯éƒ¨åˆ†
for (const kw in preserveKeywordsMap) {
    let match = newTitle.match(new RegExp(kw, 'i'));
    if (match) {
        preservedParts.push(preserveKeywordsMap[kw]); // ä½¿ç”¨æ›¿æ¢è¯
        newTitle = newTitle.replace(match[0], ''); // å»é™¤å·²åŒ¹é…çš„å…³é”®è¯éƒ¨åˆ†
    }
}

// åŒ¹é…åœ°åŒºå…³é”®è¯ï¼Œå¹¶ç”¨æ ‡è¯†ç¬¦æ›¿æ¢èŠ‚ç‚¹åç§°
for (const keyword in keywordsToNames) {
    if (new RegExp(keyword, 'i').test(newTitle)) {
        newTitle = keywordsToNames[keyword];
        break;
    }
}

// æ·»åŠ è‡ªå®šä¹‰å‰ç¼€å­—ç¬¦
newTitle = customCharStart + newTitle;

const map = globalThis.map || (globalThis.map = {});

// é˜²æ­¢èŠ‚ç‚¹æ ‡é¢˜é‡å¤
if (!map[newTitle]) {
    map[newTitle] = 1;
} else {
    newTitle = `${newTitle}-${++map[newTitle]}`;
}

// æ·»åŠ è‡ªå®šä¹‰åç¼€å­—ç¬¦
newTitle += customCharEnd;

// å°†ä¿ç•™çš„éƒ¨åˆ†é‡æ–°åŠ åˆ°æ ‡é¢˜ä¸Š
if (preservedParts.length) newTitle += ' ' + preservedParts.join(' ');

// æ›´æ–°æœåŠ¡å™¨æ ‡é¢˜
$server.title = newTitle;

return true;
let customCharStart = "➠";
let customCharEnd = "ᵀᶻ";

// 国家和地区与标识符的映射
const keywordsToNames = {
    "美国|美國|US|洛杉矶|Los Angeles|西雅图|Seattle|Atlanta|纽约|New York|芝加哥|Chicago|States|American": "🇺🇸US",
    "港|香港|HK|Hong Kong": "🇭🇰HK",
    "新加坡|狮城|SG|Singapore": "🇸🇬SG",
    "台|台湾|台北|Taipei|高雄|Kaohsiung|TW|Taiwan": "🇨🇳TW",
    "日|东京|Tokyo|大阪|Osaka|名古屋|Nagoya|JP|Japan": "🇯🇵JP",
    "韩国|首尔|Seoul|釜山|Busan|KR": "🇰🇷KR",
    "土耳其|伊斯坦布尔|Istanbul|安卡拉|Ankara|TR": "🇹🇷TR",
    "爱尔兰|都柏林|Dublin|IE": "🇮🇪IRL",
    "澳|悉尼|Sydney|墨尔本|Melbourne|布里斯班|Brisbane|AU": "🇦🇺AU",
    "法国|巴黎|Paris|里昂|Lyon|马赛|Marseille|FR": "🇫🇷FRA",
    "瑞典|斯德哥尔摩|Stockholm|哥德堡|Gothenburg|SE": "🇸🇪SE",
    "德国|法兰克福|Frankfurt|柏林|Berlin|慕尼黑|Munich|DE": "🇩🇪DE",
    "英国|伦敦|London|曼彻斯特|Manchester|伯明翰|Birmingham|GB": "🇬🇧GB",
    "印度|孟买|Mumbai|德里|Delhi|班加罗尔|Bangalore|IN": "🇮🇳IN",
    "加拿大|多伦多|Toronto|温哥华|Vancouver|蒙特利尔|Montreal|CA": "🇨🇦CA",
    "西班牙|马德里|Madrid|巴塞罗那|Barcelona|ES": "🇪🇸ES",
    "意大利|罗马|Rome|米兰|Milan|那不勒斯|Naples|IT": "🇮🇹IT",
    "荷兰|阿姆斯特丹|Amsterdam|鹿特丹|Rotterdam|NL": "🇳🇱NL",
    "瑞士|苏黎世|Zurich|日内瓦|Geneva|CH": "🇨🇭CH",
    "俄罗斯|莫斯科|Moscow|圣彼得堡|Saint Petersburg|RU": "🇷🇺RU",
    "巴西|圣保罗|Sao Paulo|里约热内卢|Rio de Janeiro|BR": "🇧🇷BR",
    "南非|约翰内斯堡|Johannesburg|开普敦|Cape Town|ZA": "🇿🇦ZA",
    "墨西哥|墨西哥城|Mexico City|瓜达拉哈拉|Guadalajara|MX": "🇲🇽MX",
    "阿根廷|布宜诺斯艾利斯|Buenos Aires|AR": "🇦🇷AR",
    "波兰|华沙|Warsaw|克拉科夫|Krakow|PL": "🇵🇱PL",
    "泰国|曼谷|Bangkok|清迈|Chiang Mai|TH|Thailand": "🇹🇭TH",
    "马来西亚|吉隆坡|Kuala Lumpur|槟城|Penang|MY|Malaysia": "🇲🇾MY",
    "越南|河内|Hanoi|胡志明|Ho Chi Minh|VN|Vietnam": "🇻🇳VN"
};

// 过滤关键词
const filterKeywords = [
    "广告", "过期", "无效", "测试", "备用", "官网", "账号", "有效期", "群", 
    "到期", "刷新", "剩余", "电报", "会员", "解锁", "流量", "超时", 
    "订阅", "佣金", "免翻", "节点", "下载", "更新", "点外", "重置", 
    "免流", "Days", "Date", "Expire", "Premium", "建议", "免费"
];

// 跳过关键词
const skipKeywords = ["GPT", "想要保留的关键词2"];

// 检查是否包含过滤关键词
if (filterKeywords.some(kw => new RegExp(kw, 'i').test($server.title))) return false;

let preservedParts = [], newTitle = $server.title;

// 处理跳过关键词，保留并移除
skipKeywords.forEach(kw => {
    let match = newTitle.match(new RegExp(kw, 'i'));
    if (match) {
        preservedParts.push(match[0]);
        newTitle = newTitle.replace(match[0], '');
    }
});

// 匹配关键词并更新标题
for (const keyword in keywordsToNames) {
    if (new RegExp(keyword, 'i').test(newTitle)) {
        newTitle = keywordsToNames[keyword];
        break;
    }
}

// 添加自定义字符
newTitle = customCharStart + newTitle;

const map = globalThis.map || (globalThis.map = {});

// 处理标题重复的情况
if (!map[newTitle]) {
    map[newTitle] = 1;
} else {
    newTitle = `${newTitle}-${++map[newTitle]}`;
}

// 添加结束字符
newTitle += customCharEnd;

// 添加保留的部分
if (preservedParts.length) newTitle += ' ' + preservedParts.join(' ');

// 更新服务器标题
$server.title = newTitle;

return true;
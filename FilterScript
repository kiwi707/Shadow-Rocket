let customCharStart = "â ";
let customCharEnd = "áµ€á¶»";

// å›½å®¶å’Œåœ°åŒºä¸æ ‡è¯†ç¬¦çš„æ˜ å°„
const keywordsToNames = {
    "ç¾å›½|ç¾åœ‹|US|æ´›æ‰çŸ¶|Los Angeles|è¥¿é›…å›¾|Seattle|Atlanta|çº½çº¦|New York|èŠåŠ å“¥|Chicago|States|American": "ğŸ‡ºğŸ‡¸US",
    "æ¸¯|é¦™æ¸¯|HK|Hong Kong": "ğŸ‡­ğŸ‡°HK",
    "æ–°åŠ å¡|ç‹®åŸ|SG|Singapore": "ğŸ‡¸ğŸ‡¬SG",
    "å°|å°æ¹¾|å°åŒ—|Taipei|é«˜é›„|Kaohsiung|TW|Taiwan": "ğŸ‡¨ğŸ‡³TW",
    "æ—¥|ä¸œäº¬|Tokyo|å¤§é˜ª|Osaka|åå¤å±‹|Nagoya|JP|Japan": "ğŸ‡¯ğŸ‡µJP",
    "éŸ©å›½|é¦–å°”|Seoul|é‡œå±±|Busan|KR": "ğŸ‡°ğŸ‡·KR",
    "åœŸè€³å…¶|ä¼Šæ–¯å¦å¸ƒå°”|Istanbul|å®‰å¡æ‹‰|Ankara|TR": "ğŸ‡¹ğŸ‡·TR",
    "çˆ±å°”å…°|éƒ½æŸæ—|Dublin|IE": "ğŸ‡®ğŸ‡ªIRL",
    "æ¾³|æ‚‰å°¼|Sydney|å¢¨å°”æœ¬|Melbourne|å¸ƒé‡Œæ–¯ç­|Brisbane|AU": "ğŸ‡¦ğŸ‡ºAU",
    "æ³•å›½|å·´é»|Paris|é‡Œæ˜‚|Lyon|é©¬èµ›|Marseille|FR": "ğŸ‡«ğŸ‡·FRA",
    "ç‘å…¸|æ–¯å¾·å“¥å°”æ‘©|Stockholm|å“¥å¾·å ¡|Gothenburg|SE": "ğŸ‡¸ğŸ‡ªSE",
    "å¾·å›½|æ³•å…°å…‹ç¦|Frankfurt|æŸæ—|Berlin|æ…•å°¼é»‘|Munich|DE": "ğŸ‡©ğŸ‡ªDE",
    "è‹±å›½|ä¼¦æ•¦|London|æ›¼å½»æ–¯ç‰¹|Manchester|ä¼¯æ˜ç¿°|Birmingham|GB": "ğŸ‡¬ğŸ‡§GB",
    "å°åº¦|å­Ÿä¹°|Mumbai|å¾·é‡Œ|Delhi|ç­åŠ ç½—å°”|Bangalore|IN": "ğŸ‡®ğŸ‡³IN",
    "åŠ æ‹¿å¤§|å¤šä¼¦å¤š|Toronto|æ¸©å“¥å|Vancouver|è’™ç‰¹åˆ©å°”|Montreal|CA": "ğŸ‡¨ğŸ‡¦CA",
    "è¥¿ç­ç‰™|é©¬å¾·é‡Œ|Madrid|å·´å¡ç½—é‚£|Barcelona|ES": "ğŸ‡ªğŸ‡¸ES",
    "æ„å¤§åˆ©|ç½—é©¬|Rome|ç±³å…°|Milan|é‚£ä¸å‹’æ–¯|Naples|IT": "ğŸ‡®ğŸ‡¹IT",
    "è·å…°|é˜¿å§†æ–¯ç‰¹ä¸¹|Amsterdam|é¹¿ç‰¹ä¸¹|Rotterdam|NL": "ğŸ‡³ğŸ‡±NL",
    "ç‘å£«|è‹é»ä¸–|Zurich|æ—¥å†…ç“¦|Geneva|CH": "ğŸ‡¨ğŸ‡­CH",
    "ä¿„ç½—æ–¯|è«æ–¯ç§‘|Moscow|åœ£å½¼å¾—å ¡|Saint Petersburg|RU": "ğŸ‡·ğŸ‡ºRU",
    "å·´è¥¿|åœ£ä¿ç½—|Sao Paulo|é‡Œçº¦çƒ­å†…å¢|Rio de Janeiro|BR": "ğŸ‡§ğŸ‡·BR",
    "å—é|çº¦ç¿°å†…æ–¯å ¡|Johannesburg|å¼€æ™®æ•¦|Cape Town|ZA": "ğŸ‡¿ğŸ‡¦ZA",
    "å¢¨è¥¿å“¥|å¢¨è¥¿å“¥åŸ|Mexico City|ç“œè¾¾æ‹‰å“ˆæ‹‰|Guadalajara|MX": "ğŸ‡²ğŸ‡½MX",
    "é˜¿æ ¹å»·|å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯|Buenos Aires|AR": "ğŸ‡¦ğŸ‡·AR",
    "æ³¢å…°|åæ²™|Warsaw|å…‹æ‹‰ç§‘å¤«|Krakow|PL": "ğŸ‡µğŸ‡±PL",
    "æ³°å›½|æ›¼è°·|Bangkok|æ¸…è¿ˆ|Chiang Mai|TH|Thailand": "ğŸ‡¹ğŸ‡­TH",
    "é©¬æ¥è¥¿äºš|å‰éš†å¡|Kuala Lumpur|æ§ŸåŸ|Penang|MY|Malaysia": "ğŸ‡²ğŸ‡¾MY",
    "è¶Šå—|æ²³å†…|Hanoi|èƒ¡å¿—æ˜|Ho Chi Minh|VN|Vietnam": "ğŸ‡»ğŸ‡³VN"
};

// è¿‡æ»¤å…³é”®è¯
const filterKeywords = [
    "å¹¿å‘Š", "è¿‡æœŸ", "æ— æ•ˆ", "æµ‹è¯•", "å¤‡ç”¨", "å®˜ç½‘", "è´¦å·", "æœ‰æ•ˆæœŸ", "ç¾¤", 
    "åˆ°æœŸ", "åˆ·æ–°", "å‰©ä½™", "ç”µæŠ¥", "ä¼šå‘˜", "è§£é”", "æµé‡", "è¶…æ—¶", 
    "è®¢é˜…", "ä½£é‡‘", "å…ç¿»", "èŠ‚ç‚¹", "ä¸‹è½½", "æ›´æ–°", "ç‚¹å¤–", "é‡ç½®", 
    "å…æµ", "Days", "Date", "Expire", "Premium", "å»ºè®®", "å…è´¹"
];

// è·³è¿‡å…³é”®è¯
const skipKeywords = ["GPT", "æƒ³è¦ä¿ç•™çš„å…³é”®è¯2"];

// æ£€æŸ¥æ˜¯å¦åŒ…å«è¿‡æ»¤å…³é”®è¯
if (filterKeywords.some(kw => new RegExp(kw, 'i').test($server.title))) return false;

let preservedParts = [], newTitle = $server.title;

// å¤„ç†è·³è¿‡å…³é”®è¯ï¼Œä¿ç•™å¹¶ç§»é™¤
skipKeywords.forEach(kw => {
    let match = newTitle.match(new RegExp(kw, 'i'));
    if (match) {
        preservedParts.push(match[0]);
        newTitle = newTitle.replace(match[0], '');
    }
});

// åŒ¹é…å…³é”®è¯å¹¶æ›´æ–°æ ‡é¢˜
for (const keyword in keywordsToNames) {
    if (new RegExp(keyword, 'i').test(newTitle)) {
        newTitle = keywordsToNames[keyword];
        break;
    }
}

// æ·»åŠ è‡ªå®šä¹‰å­—ç¬¦
newTitle = customCharStart + newTitle;

const map = globalThis.map || (globalThis.map = {});

// å¤„ç†æ ‡é¢˜é‡å¤çš„æƒ…å†µ
if (!map[newTitle]) {
    map[newTitle] = 1;
} else {
    newTitle = `${newTitle}-${++map[newTitle]}`;
}

// æ·»åŠ ç»“æŸå­—ç¬¦
newTitle += customCharEnd;

// æ·»åŠ ä¿ç•™çš„éƒ¨åˆ†
if (preservedParts.length) newTitle += ' ' + preservedParts.join(' ');

// æ›´æ–°æœåŠ¡å™¨æ ‡é¢˜
$server.title = newTitle;

return true;
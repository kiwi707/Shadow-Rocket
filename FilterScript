let customCharStart = "â—";
let customCharEnd = "áµ€á¶»";

// å›½å®¶å’Œåœ°åŒºä¸æ ‡è¯†ç¬¦çš„æ˜ å°„
const keywordsToNames = {
    "ç¾å›½|ç¾åœ‹|US|æ´›æ‰çŸ¶|è¥¿é›…å›¾|çº½çº¦|èŠåŠ å“¥|States|American": "ğŸ‡ºğŸ‡¸US",
    "æ¸¯|é¦™æ¸¯|HK|Hong": "ğŸ‡­ğŸ‡°HK",
    "æ–°åŠ å¡|ç‹®åŸ|SG|Singapore": "ğŸ‡¸ğŸ‡¬SG",
    "å°|å°æ¹¾|å°åŒ—|é«˜é›„|TW|Taiwan": "ğŸ‡¨ğŸ‡³TW",
    "æ—¥|ä¸œäº¬|å¤§é˜ª|åå¤å±‹|JP|Japan": "ğŸ‡¯ğŸ‡µJP",
    "éŸ©å›½|é¦–å°”|é‡œå±±|KR": "ğŸ‡°ğŸ‡·KR",
    "åœŸè€³å…¶|ä¼Šæ–¯å¦å¸ƒå°”|å®‰å¡æ‹‰|TR": "ğŸ‡¹ğŸ‡·TR",
    "çˆ±å°”å…°|éƒ½æŸæ—|IE": "ğŸ‡®ğŸ‡ªIRL",
    "æ¾³|æ‚‰å°¼|å¢¨å°”æœ¬|å¸ƒé‡Œæ–¯ç­|AU": "ğŸ‡¦ğŸ‡ºAU",
    "æ³•å›½|å·´é»|é‡Œæ˜‚|é©¬èµ›|FR": "ğŸ‡«ğŸ‡·FRA",
    "ç‘å…¸|SE|æ–¯å¾·å“¥å°”æ‘©|å“¥å¾·å ¡": "ğŸ‡¸ğŸ‡ªSE",
    "å¾·å›½|æ³•å…°å…‹ç¦|æŸæ—|æ…•å°¼é»‘|DE": "ğŸ‡©ğŸ‡ªDE",
    "è‹±å›½|ä¼¦æ•¦|æ›¼å½»æ–¯ç‰¹|ä¼¯æ˜ç¿°|GB|UK": "ğŸ‡¬ğŸ‡§UK",
    "å°åº¦|å­Ÿä¹°|å¾·é‡Œ|ç­åŠ ç½—å°”|IN": "ğŸ‡®ğŸ‡³IN",
    "åŠ æ‹¿å¤§|å¤šä¼¦å¤š|æ¸©å“¥å|è’™ç‰¹åˆ©å°”|CA": "ğŸ‡¨ğŸ‡¦CA",
    "è¥¿ç­ç‰™|é©¬å¾·é‡Œ|å·´å¡ç½—é‚£|ES": "ğŸ‡ªğŸ‡¸ES",
    "æ„å¤§åˆ©|ç½—é©¬|ç±³å…°|é‚£ä¸å‹’æ–¯|IT": "ğŸ‡®ğŸ‡¹IT",
    "è·å…°|é˜¿å§†æ–¯ç‰¹ä¸¹|é¹¿ç‰¹ä¸¹|NL": "ğŸ‡³ğŸ‡±NL",
    "ç‘å£«|è‹é»ä¸–|æ—¥å†…ç“¦|CH": "ğŸ‡¨ğŸ‡­CH",
    "ä¿„ç½—æ–¯|è«æ–¯ç§‘|åœ£å½¼å¾—å ¡|RU": "ğŸ‡·ğŸ‡ºRU",
    "å·´è¥¿|åœ£ä¿ç½—|é‡Œçº¦çƒ­å†…å¢|BR": "ğŸ‡§ğŸ‡·BR",
    "å—é|çº¦ç¿°å†…æ–¯å ¡|å¼€æ™®æ•¦|ZA": "ğŸ‡¿ğŸ‡¦ZA",
    "å¢¨è¥¿å“¥|å¢¨è¥¿å“¥åŸ|ç“œè¾¾æ‹‰å“ˆæ‹‰|MX": "ğŸ‡²ğŸ‡½MX",
    "é˜¿æ ¹å»·|å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯|AR": "ğŸ‡¦ğŸ‡·AR",
    "æ³¢å…°|åæ²™|å…‹æ‹‰ç§‘å¤«|PL": "ğŸ‡µğŸ‡±PL"
};

// è¿‡æ»¤å…³é”®è¯
const filterKeywords = [
    "å¹¿å‘Š", "è¿‡æœŸ", "æ— æ•ˆ", "æµ‹è¯•", "å¤‡ç”¨", "å®˜ç½‘", "è´¦å·", "æœ‰æ•ˆæœŸ", "ç¾¤", 
    "åˆ°æœŸ", "åˆ·æ–°", "å‰©ä½™", "ç”µæŠ¥", "ä¼šå‘˜", "è§£é”", "æµé‡", "è¶…æ—¶", 
    "è®¢é˜…", "ä½£é‡‘", "å…ç¿»", "èŠ‚ç‚¹", "ä¸‹è½½", "æ›´æ–°", "ç‚¹å¤–", "é‡ç½®", 
    "å…æµ", "Days", "Date", "Expire", "Premium", "å»ºè®®", "å…è´¹"
];

// è·³è¿‡å…³é”®è¯
const skipKeywords = ["GPT", "æƒ³è¦ä¿ç•™çš„å…³é”®è¯2"];

// æ£€æŸ¥æ˜¯å¦åŒ…å«è¿‡æ»¤å…³é”®è¯
if (filterKeywords.some(kw => new RegExp(kw, 'i').test($server.title))) return false;

let preservedParts = [], newTitle = $server.title;

// å¤„ç†è·³è¿‡å…³é”®è¯ï¼Œä¿ç•™å¹¶ç§»é™¤
skipKeywords.forEach(kw => {
    let match = newTitle.match(new RegExp(kw, 'i'));
    if (match) {
        preservedParts.push(match[0]);
        newTitle = newTitle.replace(match[0], '');
    }
});

// åŒ¹é…å…³é”®è¯å¹¶æ›´æ–°æ ‡é¢˜
for (const keyword in keywordsToNames) {
    if (new RegExp(keyword, 'i').test(newTitle)) {
        newTitle = keywordsToNames[keyword];
        break;
    }
}

// æ·»åŠ è‡ªå®šä¹‰å­—ç¬¦
newTitle = customCharStart + newTitle;

const map = globalThis.map || (globalThis.map = {});

// å¤„ç†æ ‡é¢˜é‡å¤çš„æƒ…å†µ
if (!map[newTitle]) {
    map[newTitle] = 1;
} else {
    newTitle = `${newTitle}-${++map[newTitle]}`;
}

// æ·»åŠ ç»“æŸå­—ç¬¦
newTitle += customCharEnd;

// æ·»åŠ ä¿ç•™çš„éƒ¨åˆ†
if (preservedParts.length) newTitle += ' ' + preservedParts.join(' ');

// æ›´æ–°æœåŠ¡å™¨æ ‡é¢˜
$server.title = newTitle;

return true;